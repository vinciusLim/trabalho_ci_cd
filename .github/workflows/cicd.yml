name: CI/CD - Flask + Docker + EC2

on:
  push:
    branches: ["main"] # O pipeline ser√° disparado a cada push no branch 'main'

env:
  # Define o caminho completo da imagem no Docker Hub
  # Substitua 'seu-nome-do-repo' pelo nome do seu projeto (ex: trabalho-devops)
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/trabalho_ci_cd

jobs:
  # -------------------------------
  # JOB 1: CI (Testes)
  # -------------------------------
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Instalar Depend√™ncias
        # Assume que requirements.txt est√° na raiz ou em ./app/
        working-directory: app
        run: pip install -r requirements.txt

      - name: üõ†Ô∏è Adicionar Projeto ao PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV # Adiciona a raiz do repo ao path
      
      - name: üß™ Rodar Testes Unit√°rios
        run: pytest # Agora ele encontrar√° o m√≥dulo 'app'

  # -------------------------------
  # JOB 2: Build e Push da Imagem
  # -------------------------------
  build-and-push:
    needs: ci # S√≥ executa se os testes passarem
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout do C√≥digo
        uses: actions/checkout@v4
      
      # Tagging: Usa os 7 primeiros caracteres do SHA do commit para garantir uma tag √∫nica
      - name: üè∑Ô∏è Definir Tag da Imagem
        id: vars
        run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        
      - name: üîê Login no DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ‚öôÔ∏è Build e Push da Imagem
        uses: docker/build-push-action@v5
        with:
          context: . # Assume que o Dockerfile est√° na raiz
          file: ./app/Dockerfile
          push: true
          # Publica com a tag 'latest' e a tag baseada no SHA
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.vars.outputs.TAG }}

    outputs:
      image_tag: ${{ steps.vars.outputs.TAG }} # Passa o valor do SHA para o pr√≥ximo job

  # -------------------------------
  # JOB 3: Provisionar Infraestrutura (IaC) - NOVO JOB
  # -------------------------------
  provision-infra:
    name: üèóÔ∏è Provisionar Infraestrutura
    runs-on: ubuntu-latest
    needs: [build-and-push]
    # Define o output IP que ser√° usado no deploy
    outputs:
      server_ip: ${{ steps.ip_capture.outputs.ip }} 

    steps:
      - name: üì• Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: üîë Configurar Credenciais AWS
        # Necess√°rio para autenticar no Provider AWS e no Backend S3
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Deve ser a mesma regi√£o do main.tf

      - name: ‚öôÔ∏è Terraform Init e Apply
        id: apply
        run: |
          cd terraform/
          terraform init -upgrade   
          terraform apply -auto-approve

      - name: üîç Capturar IP P√∫blico do Output
        id: ip_capture
        run: |
          cd terraform/
          # Captura o valor do output 'public_ip'
          IP_PUBLICO=$(terraform output -raw public_ip)
          echo "ip=$IP_PUBLICO" >> $GITHUB_OUTPUT

  # -----------------------------------------------------
  # JOB 4: CD (Deploy via SSH) - IP DIN√ÇMICO
  # -----------------------------------------------------
  deploy:
    name: üöÄ Deploy na EC2 via SSH
    # üõë ALTERA√á√ÉO 1: Adicionar 'build-and-push' para capturar a tag da imagem
    needs: [build-and-push, provision-infra]
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout do C√≥digo
        uses: actions/checkout@v4
        
      - name: üöÄ Executar Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          # üõë MUDAN√áA PRINCIPAL: Usa o IP DIN√ÇMICO gerado pelo Terraform
          host: ${{ needs.provision-infra.outputs.server_ip }}
          username: ec2-user
          key: ${{ secrets.SSH_KEY }}
          
          script: |
            # --- Vari√°veis ---
            export IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            # --- Deploy ---

            if ! command -v git &> /dev/null; then
                sudo yum install -y git
            fi

            # Clona o reposit√≥rio se n√£o existir
            if [ ! -d "trabalho_ci_cd" ]; then
                git clone https://github.com/${{ github.repository_owner }}/trabalho_ci_cd.git
            fi

            cd trabalho_ci_cd || exit 1

            # Atualiza o repo
            git pull origin main      


            # Cria .env
            cat <<- EOF > .env MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }} MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }} MYSQL_USER=${{ secrets.MYSQL_USER }} MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }} EOF
            
            docker pull ${DOCKERHUB_USERNAME}/trabalho_ci_cd:$IMAGE_TAG
            
            # 4. Parar/remover o container antigo e subir o novo
            /usr/bin/docker-compose -f docker-compose.prod.yml down -v || true
            /usr/bin/docker-compose -f docker-compose.prod.yml --env-file .env up -d --force-recreate
