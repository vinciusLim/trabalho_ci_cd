name: CI/CD - Flask + Docker + IaC

on:
  push:
    branches: ["main"]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/trabalho_ci_cd

jobs:
  # ... (JOB 1: CI e JOB 2: build-and-push permanecem inalterados) ...

  # -------------------------------
  # JOB 3: Provisionar Infraestrutura (IaC) - NOVO JOB
  # -------------------------------
  provision-infra:
    name: ðŸ—ï¸ Provisionar Infraestrutura
    runs-on: ubuntu-latest
    needs: [build-and-push]
    # Define o output IP que serÃ¡ usado no deploy
    outputs:
      server_ip: ${{ steps.ip_capture.outputs.ip }} 

    steps:
      - name: ðŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ðŸ”‘ Configurar Credenciais AWS
        # NecessÃ¡rio para autenticar no Provider AWS e no Backend S3
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Deve ser a mesma regiÃ£o do main.tf

      - name: âš™ï¸ Terraform Init e Apply
        id: apply
        run: |
          cd terraform/
          terraform init # Configura o backend S3
          terraform apply -auto-approve

      - name: ðŸ” Capturar IP PÃºblico do Output
        id: ip_capture
        run: |
          cd terraform/
          # Captura o valor do output 'public_ip'
          IP_PUBLICO=$(terraform output -raw public_ip)
          echo "ip=$IP_PUBLICO" >> $GITHUB_OUTPUT

  # -----------------------------------------------------
  # JOB 4: CD (Deploy via SSH) - IP DINÃ‚MICO
  # -----------------------------------------------------
  deploy:
    name: ðŸš€ Deploy na EC2 via SSH
    needs: [provision-infra] # AGORA DEPENDE DO TERRAFORM
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸš€ Executar Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          # ðŸ›‘ MUDANÃ‡A PRINCIPAL: Usa o IP DINÃ‚MICO gerado pelo Terraform
          host: ${{ needs.provision-infra.outputs.server_ip }} 
          username: ec2-user
          key: ${{ secrets.SSH_KEY }}
          
          script: |
            # ... (Scripts de variÃ¡veis, pull, e deploy permanecem os mesmos) ...
            
            # --- VariÃ¡veis ---
            export IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            # --- Deploy ---
            cd trabalho_ci_cd
            git pull origin main
            docker pull ${DOCKERHUB_USERNAME}/trabalho_ci_cd:$IMAGE_TAG
            
            # 4. Parar/remover o container antigo e subir o novo
            /usr/bin/docker-compose -f docker-compose.prod.yml down -v || true
            /usr/bin/docker-compose -f docker-compose.prod.yml --env-file .env up -d --force-recreate